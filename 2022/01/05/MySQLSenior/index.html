<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQ高级, Helene">
    <meta name="description" content="1. mysql的架构介绍1.1 SQL配置文件二进制日志：log-bin主从复制
错误日志：log-error默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等
查询日志：log默认是关闭，记录查询的sql语句，如果开启会">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MySQ高级 | Helene</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Helene</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Helene</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQ高级</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL/">
                                <span class="chip bg-color">MySQL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/MySQL/" class="post-category">
                                MySQL
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-05
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    14.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    54 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-mysql的架构介绍"><a href="#1-mysql的架构介绍" class="headerlink" title="1. mysql的架构介绍"></a>1. mysql的架构介绍</h2><h3 id="1-1-SQL配置文件"><a href="#1-1-SQL配置文件" class="headerlink" title="1.1 SQL配置文件"></a>1.1 SQL配置文件</h3><p>二进制日志：log-bin<br>主从复制</p>
<p>错误日志：log-error<br>默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等</p>
<p>查询日志：log<br>默认是关闭，记录查询的sql语句，如果开启会降低mysql的整体性能，因为记录日志也是需要消耗系统资源</p>
<p>数据文件<br>Linux：/var/lib/mysql<br>frm文件：存放表结构<br>myd文件：存放表数据<br>myi文件：存放表索引</p>
<p>如何配置<br>windows：my.ini<br>Linux：/etc/my.cnf</p>
<h3 id="1-2-MySQL逻辑架构介绍"><a href="#1-2-MySQL逻辑架构介绍" class="headerlink" title="1.2 MySQL逻辑架构介绍"></a>1.2 MySQL逻辑架构介绍</h3><p>和其他数据库相比，MySQL有点与众不同，它的架构在多种不同场景中应用并发挥良好作用。主要体现在存储引擎的架构上，插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取相分离。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。<br><img src="/2022/01/05/MySQLSenior/1.png" alt="MySQL逻辑架构"></p>
<ol>
<li>连接层<br> 最上层是一些客户和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理，授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限</li>
<li>服务层<br>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。如果是select语句，服务器还会查询内部的缓存。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统性能</li>
<li>引擎层<br>存储引擎层，存储引擎真正负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取</li>
<li>存储层<br>数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互</li>
</ol>
<h3 id="1-3-MySQL存储引擎"><a href="#1-3-MySQL存储引擎" class="headerlink" title="1.3 MySQL存储引擎"></a>1.3 MySQL存储引擎</h3><h4 id="1-3-1-查看命令"><a href="#1-3-1-查看命令" class="headerlink" title="1.3.1 查看命令"></a>1.3.1 查看命令</h4><p>查看你的mysql现在已提供什么存储引擎</p>
<pre class=" language-mysql"><code class="language-mysql">show engines
</code></pre>
<p>查看mysql当前默认的存储引擎</p>
<pre class=" language-mysql"><code class="language-mysql">show variables like '%storage_engine%'
</code></pre>
<h4 id="1-3-2-MyISAM和InnoDB"><a href="#1-3-2-MyISAM和InnoDB" class="headerlink" title="1.3.2 MyISAM和InnoDB"></a>1.3.2 MyISAM和InnoDB</h4><table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>主外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁，即使操作一条记录也会锁住整个表，不适合高并发的操作</td>
<td>行锁，操作时只锁住某一行，不对其他行有影响，适合高并发操作</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性影响</td>
</tr>
<tr>
<td>表空间</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
<tr>
<td>默认安装</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody></table>
<h3 id="1-4-Mysql-的用户与权限管理"><a href="#1-4-Mysql-的用户与权限管理" class="headerlink" title="1.4 Mysql 的用户与权限管理"></a>1.4 Mysql 的用户与权限管理</h3><h4 id="1-4-1-MySQL的用户管理"><a href="#1-4-1-MySQL的用户管理" class="headerlink" title="1.4.1 MySQL的用户管理"></a>1.4.1 MySQL的用户管理</h4><ol>
<li>创建用户<br>CREATE USER ‘username‘@’host’ IDENTIFIED BY ‘password’;<ul>
<li>username - 你将创建的用户名</li>
<li>host - 指定该用户在哪个主机上可以登陆,如果是本地用户可用localhost, 如果想让该用户可以从任意远程主机登陆,可以使用通配符%. </li>
<li>password - 该用户的登陆密码,密码可以为空,如果为空则该用户可以不需要密码登陆服务器.<br>示创建名称为zhang3的用户，密码设为123123；  <pre class=" language-mysql"><code class="language-mysql">CREATE USER 'zhang3'@'localhost' IDENTIFIED BY '123456';
</code></pre>
</li>
</ul>
</li>
<li>了解user表<br>查看用户<pre class=" language-mysql"><code class="language-mysql">select host,user,password,select_priv,insert_priv,drop_priv from mysql.user;
</code></pre>
<img src="/2022/01/05/MySQLSenior/72.png"><br>host ：表示连接类型<br>%： 表示所有远程通过 TCP方式的连接 IP 地址 如 (192.168.1.2,127.0.0.1) 通过制定ip地址进行的TCP方式的连接机器名，通过制定网络中的机器名进行的TCP方式的连接  ::1   IPv6的本地ip地址  等同于IPv4的 127.0.0.1 。localhost 本地方式通过命令行方式的连接 ，比如mysql -u xxx -p 123xxx 方式的连接。<br>User:表示用户名，同一用户通过不同方式链接的权限是不一样的。<br>password ：密码，所有密码串通过 password(明文字符串) 生成的密文字符串。加密算法为MYSQLSHA1 ，不可逆 。 mysql 5.7 的密码保存到 authentication_string 字段中不再使用password 字段。<br>select_priv , insert_priv等为该用户所拥有的权限。        </li>
<li>设置密码<br> 修改当前用户的密码<pre class=" language-mysql"><code class="language-mysql">set password =password('123456') 
</code></pre>
修改某个用户的密码<pre class=" language-mysql"><code class="language-mysql">update mysql.user set password=password('123456') where user='li4';
flush privileges;  
#所有通过user表的修改，必须用该命令才能生效。
</code></pre>
</li>
<li>修改用户<br> 修改用户名<pre class=" language-mysql"><code class="language-mysql">update mysql.user set user='li4' where user='wang5';flush privileges;
#所有通过user表的修改，必须用该命令才能生效。   
</code></pre>
</li>
<li>删除用户<br> 不要通过delete from  user u where user=’li4’ 进行删除，系统会有残留信息保留。 <pre class=" language-mysql"><code class="language-mysql"> drop user li4 ;  
</code></pre>
</li>
</ol>
<h4 id="1-4-2-权限管理"><a href="#1-4-2-权限管理" class="headerlink" title="1.4.2 权限管理"></a>1.4.2 权限管理</h4><ol>
<li>授予权限<br>授权命令<br>grant 权限1,权限2,…权限n on 数据库名称.表名称 to 用户名@用户地址 identified by ‘连接口令’;<br>该权限如果发现没有该用户，则会直接新建一个用户。<pre class=" language-mysql"><code class="language-mysql"> grant select,insert,delete,drop on atguigudb.* to li4@localhost  ; 
 #给li4用户用本地命令行方式下，授予atguigudb这个库下的所有表的插删改查的权限
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">grant all privileges on *.* to joe@'%'  identified by '123'; 
#授予通过网络方式登录的的joe用户 ，对所有库所有表的全部权限，密码设为123.就算 all privileges 了所有权限，grant_priv 权限也只有 root 才能拥有。 
</code></pre>
  给 root 赋连接口令后<pre class=" language-mysql"><code class="language-mysql">grant all privileges on *.* to root@'%'  ;
</code></pre>
  新建的连接没有密码，需要设置密码才能远程连接。<pre class=" language-mysql"><code class="language-mysql">update user set password=password('root') where user='root' and host='%'; 
</code></pre>
</li>
<li>收回权限<br>授权命令<br>revoke  权限1,权限2,…权限n on 数据库名称.表名称  from  用户名@用户地址 ;<pre class=" language-mysql"><code class="language-mysql"> REVOKE ALL PRIVILEGES ON mysql.* FROM joe@localhost;
 #若赋的全库的表就 收回全库全表的所有权限 REVOKE 
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">select,insert,update,delete ON mysql.* FROM joe@localhost;
#收回mysql库下的所有表的插删改查权限 对比赋予权限的方法。必须用户重新登录后才能生效 
</code></pre>
</li>
<li>查看权限<br>查看当前用户权限<pre class=" language-mysql"><code class="language-mysql">show grants; 
</code></pre>
查看某用户的全局权限select  * from user ;查看某用户的某库的权限select * from  db; 查看某用户的某个表的权限select * from tables_priv;</li>
</ol>
<h4 id="1-4-3-通过远程工具访问"><a href="#1-4-3-通过远程工具访问" class="headerlink" title="1.4.3 通过远程工具访问"></a>1.4.3 通过远程工具访问</h4><ol>
<li>先 ping 一下数据库服务器的ip 地址确认网络畅通。 </li>
<li>关闭数据库服务的防火墙    service iptables stop <pre class=" language-mysql"><code class="language-mysql"> service iptables stop 
</code></pre>
</li>
<li>确认Mysql中已经有可以通过远程登录的账户    <pre class=" language-mysql"><code class="language-mysql"> select  * from mysql.user where user='li4' and host='%'; 
</code></pre>
如果没有用户,先执行如下命令<pre class=" language-mysql"><code class="language-mysql"> grant all privileges on *.*  to li4@'%'  identified by '123123';
</code></pre>
</li>
<li>测试连接：</li>
</ol>
<h4 id="1-4-3-Mysql的一些杂项配置"><a href="#1-4-3-Mysql的一些杂项配置" class="headerlink" title="1.4.3 Mysql的一些杂项配置"></a>1.4.3 Mysql的一些杂项配置</h4><ol>
<li>大小写问题<pre class=" language-mysql"><code class="language-mysql">SHOW VARIABLES LIKE '%lower_case_table_names%'
</code></pre>
</li>
</ol>
<ul>
<li>windows系统默认大小写不敏感，但是linux系统是大小写敏感的。默认为0，大小写敏感。</li>
<li>设置1，大小写不敏感。创建的表，数据库都是以小写形式存放在磁盘上，对于sql语句都是转换为小写对表和DB进行查找。</li>
<li>设置2，创建的表和DB依据语句上格式存放，凡是查找都是转换为小写进行。   设置变量常采用 set lower_case_table_names = 1； 的方式，但此变量是只读权限，所以需要在配置文件中改。</li>
<li>当想设置为大小写不敏感时，要在my.cnf这个配置文件 [mysqld] 中加入 lower_case_table_names = 1 ，然后重启服务器。但是要在重启数据库实例之前就需要将原来的数据库和表转换为小写，否则更改后将找不到数据库名。在进行数据库参数设置之前，需要掌握这个参数带来的影响，切不可盲目设置。   </li>
</ul>
<ol start="2">
<li>(生产环境)sql_mode<br>MySQL的sql_mode默认值是空值，在这种设置下是可以允许一些非法操作的，比如允许一些非法数据的插入。在生产环境必须将这个值设置为严格模式，所以开发、测试环境的数据库也必须要设置，这样在开发测试阶段就可以发现问题。<br>使用 set sql_mode=ONLY_FULL_GROUP_BY; 的方式设置会将之前的设置覆盖掉同时<br>设置多个限制：set sql_mode=’ONLY_FULL_GROUP_BY,NO_AUTO_VALUE_ON_ZERO’;<br>sql_mode常用值如下： <ul>
<li>ONLY_FULL_GROUP_BY：对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中 </li>
<li>NO_AUTO_VALUE_ON_ZERO：该值影响自增长列的插入。默认设置下，插入0或NULL代表生成下一个自增长值。如果用户 希望插入的值为0，而该列又是自增长的，那么这个选项就有用了。 </li>
<li>STRICT_TRANS_TABLES：在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做限制</li>
<li>NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零    NO_ZERO_DATE：设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</li>
<li>ERROR_FOR_DIVISION_BY_ZERO：在INSERT或UPDATE过程中，如果数据被零除，则产生错误而非警告。如 果未给出该模式，那么数据被零除时MySQL返回</li>
<li>NULL NO_AUTO_CREATE_USER：禁止GRANT创建密码为空的用户 </li>
<li>NO_ENGINE_SUBSTITUTION：如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常 PIPES_AS_CONCAT：将”||”视为字符串的连接操作符而非或运算符，这和Oracle数据库是一样的，也和字符串的拼接函数Concat相类似</li>
<li>ANSI_QUOTES：启用ANSI_QUOTES后，不能用双引号来引用字符串，因为它被解释为识别符 ORACLE：  设置等同：PIPES_AS_CONCAT, ANSI_QUOTES, IGNORE_SPACE, NO_KEY_OPTIONS, NO_TABLE_OPTIONS, NO_FIELD_OPTIONS, NO_AUTO_CREATE_USER.</li>
</ul>
</li>
</ol>
<h2 id="2-索引优化"><a href="#2-索引优化" class="headerlink" title="2. 索引优化"></a>2. 索引优化</h2><h3 id="2-1-性能下降SQL慢，执行时间长，等待时间长"><a href="#2-1-性能下降SQL慢，执行时间长，等待时间长" class="headerlink" title="2.1 性能下降SQL慢，执行时间长，等待时间长"></a>2.1 性能下降SQL慢，执行时间长，等待时间长</h3><p>查询语句写的烂<br>索引失效（单值、复合）<br>关联查询太多join（设计缺陷或不得已的需求）<br>服务器调优及各个参数设置（缓冲、线程数）</p>
<h3 id="2-2-常见通用的join查询"><a href="#2-2-常见通用的join查询" class="headerlink" title="2.2 常见通用的join查询"></a>2.2 常见通用的join查询</h3><h4 id="2-2-1-SQL执行顺序"><a href="#2-2-1-SQL执行顺序" class="headerlink" title="2.2.1 SQL执行顺序"></a>2.2.1 SQL执行顺序</h4><p><strong>手写：</strong><br><img src="/2022/01/05/MySQLSenior/2.png"><br><strong>机读：</strong><br><img src="/2022/01/05/MySQLSenior/3.png"></p>
<p><strong>总结：</strong><br><img src="/2022/01/05/MySQLSenior/4.png"></p>
<h4 id="2-2-2-join图"><a href="#2-2-2-join图" class="headerlink" title="2.2.2 join图"></a>2.2.2 join图</h4><p><strong>left join</strong><br><img src="/2022/01/05/MySQLSenior/64.png" alt="left join"></p>
<p><strong>right join</strong><br><img src="/2022/01/05/MySQLSenior/65.png" alt="right join"></p>
<p><strong>inner join</strong><br><img src="/2022/01/05/MySQLSenior/66.png" alt="inner join"></p>
<p><strong>full outer join</strong><br><img src="/2022/01/05/MySQLSenior/67.png" alt="full outer join"></p>
<p><img src="/2022/01/05/MySQLSenior/68.png" alt="full outer join"></p>
<h3 id="2-3-索引简介"><a href="#2-3-索引简介" class="headerlink" title="2.3 索引简介"></a>2.3 索引简介</h3><h4 id="2-3-1-索引是什么"><a href="#2-3-1-索引是什么" class="headerlink" title="2.3.1 索引是什么"></a>2.3.1 索引是什么</h4><ol>
<li>MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构。可以得到索引的本质：索引是数据结构。</li>
<li>你可以简单理解为“排好序的快速查找数据结构”。<ul>
<li>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。下图就是一种可能的索引方式示例：左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址 为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录。二叉树弊端之一：二叉树很可能会发生两边不平衡的情况。B-TREE: (B:balance)  会自动根据两边的情况自动调节，使两端无限趋近于平衡状态。可以使性能最稳定。(myisam使用的方式)    B-TREE弊端：(插入/修改操作多时，B-TREE会不断调整平衡，消耗性能)从侧面说明了索引不是越多越好。B+TREE:Innodb 所使用的索引  </li>
<li>数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。 </li>
</ul>
</li>
<li>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上</li>
<li>我们平常所说的索引，如果没有特别指明，都是指B树(多路搜索树，并不一定是二叉的)结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈稀索引(hash index)等。</li>
</ol>
<h4 id="2-3-2-索引的优势"><a href="#2-3-2-索引的优势" class="headerlink" title="2.3.2 索引的优势"></a>2.3.2 索引的优势</h4><ol>
<li>类似大学图书馆建书目索引，提高数据检索的效率，降低数据库的IO成本</li>
<li>通过索引列对数据进行排序，降低数据排序的成本，降低了CPU的消耗</li>
</ol>
<h4 id="2-3-3-索引的劣势"><a href="#2-3-3-索引的劣势" class="headerlink" title="2.3.3 索引的劣势"></a>2.3.3 索引的劣势</h4><ol>
<li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的</li>
<li>虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</li>
<li>索引只是提高效率的一个因素，如果你的MySQL有大数据量的表，就需要花时间研究建立最优秀的索引，或优化查询语句</li>
</ol>
<h4 id="2-3-4-mysql索引分类"><a href="#2-3-4-mysql索引分类" class="headerlink" title="2.3.4 mysql索引分类"></a>2.3.4 mysql索引分类</h4><ol>
<li>主键索引<br> 设定为主键后数据库会自动建立索引，innodb为聚簇索引</li>
<li>单值索引<br> 即一个索引只包含单个列，一个表可以有多个单列索引</li>
<li>唯一索引<br> 索引列的值必须唯一，但允许有空值</li>
<li>复合索引<br> 即一个索引包含多个列</li>
<li>基本语法：<br> 有四种方式来添加数据表的索引：<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE tbl_name ADD PRIMARY KEY (column_list)
#该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL。
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE tbl_name ADD UNIQUE index_name (column_list)
#这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）。
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE tbl_name ADD INDEX index_name (column_list)
# 添加普通索引，索引值可出现多次。
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE tbl_name ADD FULLTEXT index_name (column_list)
#该语句指定了索引为 FULLTEXT ，用于全文索引。 
</code></pre>
 删除：<pre class=" language-mysql"><code class="language-mysql">DROP INDEX [indexName] ON mytable; 
</code></pre>
 查看：<pre class=" language-mysql"><code class="language-mysql">SHOW INDEX FROM table_name\G
</code></pre>
</li>
</ol>
<h4 id="2-3-5-mysql索引结构"><a href="#2-3-5-mysql索引结构" class="headerlink" title="2.3.5 mysql索引结构"></a>2.3.5 mysql索引结构</h4><ol>
<li>BTree索引<br>检索原理：<br><img src="/2022/01/05/MySQLSenior/69.png"><br>【初始化介绍】 一颗b树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示），如磁盘块1包含数据项17和35，包含指针P1、P2、P3，P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。真实的数据存在于叶子节点即3、5、9、10、13、15、28、29、36、60、75、79、90、99。非叶子节点不存储真实的数据，只存储指引搜索方向的数据项，如17、35并不真实存在于数据表中。<br>【查找过程】如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO，在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。 真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高。</li>
<li>B+Tree索引</li>
<li>聚簇索引与非聚簇索引</li>
<li>full-text全文索引</li>
<li>Hash索引</li>
<li>R-Tree索引</li>
</ol>
<h4 id="2-3-6-哪些情况需要创建索引"><a href="#2-3-6-哪些情况需要创建索引" class="headerlink" title="2.3.6 哪些情况需要创建索引"></a>2.3.6 哪些情况需要创建索引</h4><ol>
<li>主键自动建立唯一索引</li>
<li>频繁作为查询条件的字段应该创建索引(where 后面的语句)</li>
<li>查询中与其它表关联的字段，外键关系建立索引</li>
<li>单键/组合索引的选择问题，who？(在高并发下倾向创建组合索引)</li>
<li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</li>
<li>查询中统计或者分组字段</li>
</ol>
<h4 id="2-3-7-哪些情况不要创建索引"><a href="#2-3-7-哪些情况不要创建索引" class="headerlink" title="2.3.7 哪些情况不要创建索引"></a>2.3.7 哪些情况不要创建索引</h4><ol>
<li>表记录太少</li>
<li>经常增删改的表。Why:提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件</li>
<li>Where条件里用不到的字段不创建索引。索引建多了影响 增删改 的效率</li>
<li>数据重复且分布平均的表字段，因此应该只为最经常查询和最经常排序的数据列建立索引。注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。</li>
</ol>
<h3 id="2-4-性能分析"><a href="#2-4-性能分析" class="headerlink" title="2.4 性能分析"></a>2.4 性能分析</h3><h4 id="2-4-1-MySQL-Query-Optimizer"><a href="#2-4-1-MySQL-Query-Optimizer" class="headerlink" title="2.4.1 MySQL Query Optimizer"></a>2.4.1 MySQL Query Optimizer</h4><ol>
<li>MySQL中有专门负责优化select语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供它认为最优的执行计划（它认为最优的数据检索方式，但不见得是DBA认为是最优的，这部分最耗时间）</li>
<li>当客户端向MySQL请求一条query，命令解析器模块完成请求分类，区别是select转发给MySQL Query Optimizer时，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算，直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query中的Hint信息（如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint或Hint信息还不足以完全确定执行计划，则会读取锁所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划。</li>
</ol>
<h4 id="2-4-2-MySQL常见瓶颈"><a href="#2-4-2-MySQL常见瓶颈" class="headerlink" title="2.4.2 MySQL常见瓶颈"></a>2.4.2 MySQL常见瓶颈</h4><ol>
<li>CPU<br>CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据的时候<br>SQL中对大量数据进行比较、关联、排序、分组</li>
<li>IO<br> 磁盘I/O瓶颈发生在装入数据远大于内存容量的时候<ul>
<li>实例内存满足不了缓存数据或排序等需要，导致产生大量 物理 IO。</li>
<li>查询执行效率低，扫描过多数据行。</li>
</ul>
</li>
<li>锁<ul>
<li>不适宜的锁的设置，导致线程阻塞，性能下降。</li>
<li>死锁，线程之间交叉调用资源，导致死锁，程序卡住。</li>
</ul>
</li>
<li>服务器硬件的性能瓶颈<br>top,free, iostat和vmstat来查看系统的性能状态 </li>
</ol>
<h4 id="2-4-3-Explain"><a href="#2-4-3-Explain" class="headerlink" title="2.4.3 Explain"></a>2.4.3 Explain</h4><ol>
<li>是什么<br>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是表结构的性能瓶颈<br>官网：<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.5/en/explain-output.html">http://dev.mysql.com/doc/refman/5.5/en/explain-output.html</a></li>
<li>能干嘛<ul>
<li>表的读取顺序</li>
<li>哪些索引可以使用</li>
<li>数据读取操作的操作类型</li>
<li>哪些索引被实际使用</li>
<li>表之间的引用</li>
<li>每张表有多少行被优化器查询</li>
</ul>
</li>
<li>怎么玩<br>Explain + SQL语句<br>执行计划包含的信息：<br><img src="/2022/01/05/MySQLSenior/5.png"></li>
<li>各字段解释<ol>
<li>id<ul>
<li>select查询的序列号,包含一组数字，表示查询中执行select子句或操作表的顺序</li>
<li>三种情况<ul>
<li>id相同，执行顺序由上至下</li>
<li>id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</li>
</ul>
</li>
</ul>
</li>
<li>select_type<br> 查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询<ul>
<li>SIMPLE：简单的 select 查询,查询中不包含子查询或者UNION</li>
<li>PRIMARY：查询中若包含任何复杂的子部分，最外层查询则被标记为Primary</li>
<li>DERIVED：在FROM列表中包含的子查询被标记为DERIVED(衍生)MySQL会递归执行这些子查询, 把结果放在临时表里。</li>
<li>SUBQUERY：在SELECT或WHERE列表中包含了子查询</li>
<li>DEPENDENT SUBQUERY：在SELECT或WHERE列表中包含了子查询,子查询基于外层</li>
<li>UNCACHEABLE SUBQUREY：无法被缓存的子查询</li>
<li>UNION：若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中,外层SELECT将被标记为：DERIVED</li>
<li>UNION RESULT：从UNION表获取结果的SELECT</li>
</ul>
</li>
<li>table<br>显示这一行的数据是关于哪张表的</li>
<li>type<br>访问类型排列。显示查询使用了何种类型，<br>从最好到最差依次是：<br>system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL<ul>
<li>system：表只有一行记录（等于系统表），这是const类型的特列，平时不会出现，这个也可以忽略不计</li>
<li>const：表示通过索引一次就找到了,const用于比较primary key或者unique索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL就能将该查询转换为一个常量</li>
<li>eq_ref：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描</li>
<li>ref：非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体</li>
<li>range：只检索给定范围的行,使用一个索引来选择行。key 列显示使用了哪个索引。一般就是在你的where语句中出现了between、&lt;、&gt;、in等的查询。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束语另一点，不用扫描全部索引。</li>
<li>index：Full Index Scan，index与ALL区别为index类型只遍历索引树。这通常比ALL快，因为索引文件通常比数据文件小。（也就是说虽然all和Index都是读全表，但index是从索引中读取的，而all是从硬盘中读的）</li>
<li>all：Full Table Scan，将遍历全表以找到匹配的行<br>注意：一般来说，得保证查询至少达到range级别，最好能达到ref。</li>
</ul>
</li>
<li>possible_keys<br>显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</li>
<li>key<br>实际使用的索引。如果为NULL，则没有使用索引。查询中若使用了覆盖索引，则该索引和查询的select字段重叠<br>覆盖索引：select查询后的字段与索引的字段顺序，个数都一致</li>
<li>key_len<br>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。 在不损失精确性的情况下，长度越短越好。<br>key_len显示的值为索引字段的最大可能长度，并非实际使用的长度，即key_len是根据表定义计算而得，不是通过表内检索出的。<br>key_len字段能够帮你检查是否充分的利用上了索引</li>
<li>ref<br>显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</li>
<li>rows<br> 根据表统计信息及索引选用情况，大致估算出找到所需记录所需要读取的行数。（每张表有多少行被优化器查询）。</li>
<li>Extra<br>包含不适合在其他列中显示但十分重要的额外信息<ul>
<li>Using filesort<br>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为“文件排序”</li>
<li>Using temporary<br>使了用临时表保存中间结果,MySQL在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by。</li>
<li>USING index<br>表示相应的select操作中使用了覆盖索引(Covering Index)，避免访问了表的数据行，效率不错！<br>如果同时出现using where，表明索引被用来执行索引键值的查找;<br>如果没有同时出现using where，表明索引只是用来读取数据而非利用索引执行查找。</li>
<li>Using where<br>表明使用了where过滤</li>
<li>using join buffer<br>使用了连接缓存：</li>
<li>impossible where<br>where子句的值总是false，不能用来获取任何元组</li>
<li>select tables optimized away<br>在没有GROUPBY子句的情况下，基于索引优化MIN/MAX操作或者对于MyISAM存储引擎优化COUNT(*)操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</li>
<li>distinct<br> 优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作</li>
</ul>
</li>
</ol>
</li>
</ol>
<h4 id="2-4-4-索引优化"><a href="#2-4-4-索引优化" class="headerlink" title="2.4.4 索引优化"></a>2.4.4 索引优化</h4><p>索引分析</p>
<ol>
<li><p>单表：</p>
<pre class=" language-mysql"><code class="language-mysql">#查询 category_id 为1 且  comments 大于 1 的情况下,views 最多的 article_id。       
EXPLAIN SELECT id,author_id FROM article WHERE category_id = 1 AND comments > 1 ORDER BY views DESC LIMIT 1; 
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/6.png"><br> 结论:type 是 ALL,即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。<br> <strong>开始优化：</strong></p>
<ol>
<li>新建索引+删除索引<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE `article` ADD INDEX idx_article_ccv ( `category_id` , `comments`, `views` );
create index idx_article_ccv on article(category_id,comments,views);DROP INDEX idx_article_ccv ON article 
</code></pre>
</li>
<li>explain <pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT id,author_id FROM `article` WHERE category_id = 1 AND comments >1 ORDER BY views DESC LIMIT 1; 
</code></pre>
 <img src="/2022/01/05/MySQLSenior/7.png"><br> 结论：<br> type 变成了 range,这是可以忍受的。但是 extra 里使用 Using filesort 仍是无法接受的。<br> 但是我们已经建立了索引,为啥没用呢?<br> 这是因为按照 BTree 索引的工作原理,先排序 category_id,如果遇到相同的 category_id 则再排序 comments,如果遇到相同的 comments 则再排序 views。当 comments 字段在联合索引里处于中间位置时,因comments &gt; 1 条件是一个范围值(所谓 range),MySQL 无法利用索引再对后面的 views 部分进行检索,即 range 类型查询字段后面的索引无效。  </li>
<li>删除第一次建立的索引<pre class=" language-mysql"><code class="language-mysql">DROP INDEX idx_article_ccv ON article; 
</code></pre>
</li>
<li>第2次新建索引<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE `article` ADD INDEX idx_article_cv ( `category_id` , `views` ) ;
create index idx_article_cv on article(category_id,views); 
</code></pre>
</li>
<li>第3次explain<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT id,author_id FROM article WHERE category_id = 1 AND comments > 1 ORDER BY views DESC LIMIT 1;
</code></pre>
 <img src="/2022/01/05/MySQLSenior/8.png"><br> 结论：可以看到,type 变为了 ref,Extra 中的 Using filesort 也消失了,结果非常理想。</li>
</ol>
</li>
</ol>
<ol start="2">
<li>两表<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
</code></pre>
 <img src="/2022/01/05/MySQLSenior/9.png"> 结论：type 有All<br> 添加索引优化<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE `book` ADD INDEX Y ( `card`); 
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
</code></pre>
 <img src="/2022/01/05/MySQLSenior/10.png"><br> 可以看到第二行的 type 变为了 ref,rows 也变成了优化比较明显。这是由左连接特性决定的。LEFT JOIN 条件用于确定如何从右表搜索行,左边一定都有,所以右边是我们的关键点,一定需要建立索引。<br> 删除旧索引 + 新建 + 第3次explain<pre class=" language-mysql"><code class="language-mysql">DROP INDEX Y ON book;ALTER TABLE class ADD INDEX X (card);EXPLAIN       SELECT * FROM class LEFT JOIN book ON class.card = book.card;   
</code></pre>
 <img src="/2022/01/05/MySQLSenior/11.png"></li>
</ol>
<ol start="3">
<li><p>三表</p>
<pre class=" language-mysql"><code class="language-mysql">explain select * from class left join book on class.card=book.card left join phone on book.card=phone.card;
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/12.png"></p>
<pre class=" language-mysql"><code class="language-mysql">ALTER TABLE book ADD INDEX X (card);
ALTER TABLE phone ADD INDEX Y (card);
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/13.png"></p>
<p> 结论：join语句优化</p>
<ol>
<li>尽可能减少join语句中的嵌套循环的循环总次数，“永远用小结果集驱动打的结果集”</li>
<li>优先优化嵌套循环的内层循环</li>
<li>保证join语句中被驱动表上join条件字段已经被索引</li>
<li>当无法保证被驱动表的join条件字段被索引且内存资源充足的前提下，不要台吝啬joinbuffer的设置</li>
</ol>
</li>
<li><p>索引失效</p>
<ol>
<li><p>全值匹配我最爱<br>索引  idx_staffs_nameAgePos 建立索引时 以 name ， age ，pos 的顺序建立的。全值匹配表示 按顺序匹配的</p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE NAME = 'July';
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/14.png"></p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE NAME = 'July' AND age = 25;
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/15.png"></p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE NAME = 'July' AND age = 25 AND pos = 'dev';  
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/16.png" alt="全值匹配"></p>
</li>
<li><p>最佳左前缀法则<br>如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。<br>索引失效</p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE age = 25 AND pos = 'dev'; 
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/17.png" alt="跳过了索引的第一列"></p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE pos = 'dev'; 
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/18.png" alt="跳过了索引的第一列，第二列"></p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT * FROM staffs WHERE NAME = 'July'  AND pos = 'dev';
</code></pre>
<p>  <img src="/2022/01/05/MySQLSenior/19.png" alt="跳过了中间索引"></p>
</li>
<li><p>不在索引列上做任何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描<br>  <img src="/2022/01/05/MySQLSenior/20.png"></p>
</li>
<li><p>存储引擎不能使用索引中范围条件右边的列（范围之后【不含】的索引全失效。范围条件右边与范围条件使用的同一个组合索引，右边的才会失效。若是不同索引则不会失效）<br> <img src="/2022/01/05/MySQLSenior/21.png"></p>
</li>
<li><p>尽量使用覆盖索引(只访问索引的查询(索引列和查询列一致))，减少select *<br> <img src="/2022/01/05/MySQLSenior/22.png"></p>
</li>
<li><p>mysql 在使用不等于(!= 或者&lt;&gt;)的时候无法使用索引会导致全表扫描<br> <img src="/2022/01/05/MySQLSenior/23.png"></p>
</li>
<li><p>is null，is not null 也无法使用索引<br>  <img src="/2022/01/05/MySQLSenior/24.png"></p>
</li>
<li><p>like以通配符开头(‘%abc…’)mysql索引失效会变成全表扫描的操作<br> <img src="/2022/01/05/MySQLSenior/25.png"><br> 问题：解决like ‘%字符串%’时索引不被使用的方法？（覆盖索引解决）</p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT NAME,age    FROM tbl_user WHERE NAME LIKE '%aa%';

EXPLAIN SELECT id    FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT NAME     FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT age   FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id,NAME    FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id,NAME,age FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT NAME,age FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT *     FROM tbl_user WHERE NAME LIKE '%aa%';
EXPLAIN SELECT id,NAME,age,email  FROM tbl_user WHERE NAME LIKE '%aa%';
</code></pre>
<pre class=" language-mysql"><code class="language-mysql">#create indexCREATE INDEX idx_user_nameAge ON tbl_user(NAME,age);
SELECT NAME,age    FROM tbl_user WHERE NAME LIKE '%aa%';
</code></pre>
<p>  <img src="/2022/01/05/MySQLSenior/26.png"></p>
<pre class=" language-mysql"><code class="language-mysql">EXPLAIN SELECT id,NAME,age,email FROM tbl_user WHERE NAME LIKE '%aa%';
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/27.png"></p>
</li>
<li><p>字符串不加单引号索引失效<br>  底层进行类型转换使索引失效，使用了函数造成索引失效<br> <img src="/2022/01/05/MySQLSenior/28.png"></p>
</li>
<li><p>少用or,用它来连接时会索引失效<br> <img src="/2022/01/05/MySQLSenior/29.png"></p>
</li>
</ol>
</li>
</ol>
<p>一般性建议：</p>
<ol>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。(避免索引过滤性好的索引失效)</li>
<li>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
</ol>
<h2 id="3-查询截取分析"><a href="#3-查询截取分析" class="headerlink" title="3.查询截取分析"></a>3.查询截取分析</h2><h3 id="3-1-查询优化"><a href="#3-1-查询优化" class="headerlink" title="3.1 查询优化"></a>3.1 查询优化</h3><ol>
<li>永远小表驱动大表</li>
<li>order by关键字优化<ul>
<li>ORDER BY子句，尽量使用Index方式排序,避免使用FileSort方式排序<pre class=" language-mysql"><code class="language-mysql"> CREATE INDEX idx_A_ageBirth on tblA(age,birth);
 explain select * from tblA where age>20 order by age;
</code></pre>
   <img src="/2022/01/05/MySQLSenior/30.png"><pre class=" language-mysql"><code class="language-mysql"> explain select * from tblA where age>20 order by age,birth;
</code></pre>
   <img src="/2022/01/05/MySQLSenior/31.png"><pre class=" language-mysql"><code class="language-mysql"> explain select * from tblA where age>20 order by birth;
</code></pre>
   <img src="/2022/01/05/MySQLSenior/32.png"><pre class=" language-mysql"><code class="language-mysql">explain select * from tblA where age>20 order by birth,age;
</code></pre>
   <img src="/2022/01/05/MySQLSenior/33.png"><br>explain select * from tblA where birth&gt;’2016-01-28 00:00:00’ order by age ASC,birth DESC;<br><img src="/2022/01/05/MySQLSenior/34.png"><ul>
<li>MySQL支持二种方式的排序，FileSort和Index，Index效率高.它指MySQL扫描索引本身完成排序。FileSort方式效率较低。</li>
<li>ORDER BY满足两情况，会使用Index方式排序:<ul>
<li>ORDER BY 语句使用索引最左前列</li>
<li>使用Where子句与Order BY子句条件列组合满足索引最左前列</li>
<li>where子句中如果出现索引的范围查询(即explain中出现range)会导致order by 索引失效。</li>
</ul>
</li>
</ul>
</li>
<li>尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀</li>
<li>如果不在索引列上，filesort有两种算法：mysql就要启动双路排序和单路排序<ul>
<li>双路排序：<br>MySQL 4.1之前是使用双路排序,字面意思就是两次扫描磁盘，最终得到数据，读取行指针和orderby列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出<br>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</li>
<li>取一批数据，要对磁盘进行了两次扫描，众所周知，I\O是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序。</li>
<li>单路排序：<br>从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li>
<li>结论及引申出的问题：<br>由于单路是后出的，总体而言好过双路<br>但是用单路有问题</li>
<li>优化策略<br>增大sort_buffer_size参数的设置<br>增大max_length_for_sort_data参数的设置<br>去掉select 后面不需要的字段</li>
</ul>
</li>
</ul>
</li>
<li>GROUP BY关键字优化：<ol>
<li>group by实质是先排序后进行分组，遵照索引建的最佳左前缀</li>
<li>当无法使用索引列，增大max_length_for_sort_data参数的设置+增sort_buffer_size参数的设置</li>
<li>where高于having，能写在where限定的条件就不要去having限定了。</li>
</ol>
</li>
</ol>
<h3 id="3-2-慢查询日志"><a href="#3-2-慢查询日志" class="headerlink" title="3.2 慢查询日志"></a>3.2 慢查询日志</h3><p>3.2.1 是什么<br> MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。<br>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。<br>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</p>
<p>3.2.2 怎么玩</p>
<ol>
<li><p>说明<br> 默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件</p>
</li>
<li><p>查看是否开启及如何开启<br> 默认：</p>
<pre class=" language-mysql"><code class="language-mysql">SHOW VARIABLES LIKE '%slow_query_log%';
</code></pre>
<p> 开启：</p>
<pre class=" language-mysql"><code class="language-mysql">set global slow_query_log=1;
#只对当前数据库生效，如果mysql重启后则会失效
</code></pre>
</li>
<li><p>那么开启了慢查询日志后，什么样的SQL才会记录到慢查询日志里面呢？<br> 这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，命令：SHOW VARIABLES LIKE ‘long_query_time%’;可以使用命令修改，也可以在my.cnf参数里面修改。假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。 </p>
</li>
<li><p>case<br> 查看当前多少秒算慢</p>
<pre class=" language-mysql"><code class="language-mysql">SHOW VARIABLES LIKE 'long_query_time%';
</code></pre>
<p> 设置慢的阙值时间<br> 为什么设置后看不出变化？<br> 需要重新连接或新开一个会话才能看到修改值。 </p>
<pre class=" language-mysql"><code class="language-mysql">SHOW VARIABLES LIKE 'long_query_time%';
</code></pre>
<p> 或者通过set session long_query_time=1来改变当前session变量;</p>
<p> 查询当前系统中有多少条慢查询记录</p>
<pre class=" language-mysql"><code class="language-mysql">show global status like '%Slow_queries%';  
</code></pre>
<p> 配置版</p>
<pre class=" language-mysql"><code class="language-mysql">slow_query_log=1;
slow_query_log_file=/var/lib/mysql/atguigu-slow.loglong_query_time=3;log_output=FILE
</code></pre>
</li>
<li><p>日志分析工具mysqldumpslow<br> 在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。<br> 查看mysqldumpslow的帮助信息</p>
<pre class=" language-bash"><code class="language-bash">mysqldumpslow --help
</code></pre>
<p> s: 是表示按照何种方式排序；<br> c: 访问次数<br> l: 锁定时间<br> r: 返回记录<br> t: 查询行数<br> al:平均锁定时间<br> ar:平均返回记录数<br> at:平均查询时间<br> t:即为返回前面多少条的数据；<br> g:后边搭配一个正则匹配模式，大小写不敏感的；</p>
</li>
</ol>
<h3 id="3-4-show-profile"><a href="#3-4-show-profile" class="headerlink" title="3.4 show profile"></a>3.4 show profile</h3><ol>
<li>是什么<br>是mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量<br>官网：<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.5/en/show-profile.html">http://dev.mysql.com/doc/refman/5.5/en/show-profile.html</a><br>默认情况下，参数处于关闭状态，并保存最近15次的运行结果</li>
<li>分析步骤<ul>
<li>是否支持，看看当前的mysql版本是否支持<br>  Show  variables like ‘profiling’;默认是关闭，使用前需要开启     </li>
<li>开启功能，默认是关闭，使用前需要开启<br> show variables like ‘profiling’; set profiling=1; </li>
<li>运行SQL<br>select * from emp group by id%10 limit 150000;<br>select * from emp group by id%20  order by 5</li>
<li>查看结果，show profiles;</li>
<li>诊断SQL，show profile cpu,block io for query  n  (n为上一步前面的问题SQL数字号码);<br>type:   ALL       –显示所有的开销信息<br>BLOCK IO         –显示块IO相关开销<br>CONTEXT SWITCHES –上下文切换相关开销<br>CPU              –显示CPU相关开销信息<br>IPC              –显示发送和接收相关开销信息<br>MEMORY           –显示内存相关开销信息<br>PAGE FAULTS      –显示页面错误相关开销信息<br>SOURCE           –显示和Source_function，Source_file，Source_line相关的开销信息<br>SWAPS            –显示交换次数相关开销的信息</li>
</ul>
</li>
</ol>
<ul>
<li>日常开发需要注意的结论<ul>
<li>converting HEAP to MyISAM 查询结果太大，内存都不够用了往磁盘上搬了。</li>
<li>Creating tmp table 创建临时表<ul>
<li> 1 select * from emp group by id%20 limit 120000; 2  select * from emp group by id%20  order by 5 </li>
<li>拷贝数据到临时表</li>
<li>用完再删除</li>
</ul>
</li>
<li>Copying to tmp table on disk 把内存中临时表复制到磁盘，危险！！！</li>
<li>locked</li>
</ul>
</li>
</ul>
<h3 id="3-5-全局查询日志"><a href="#3-5-全局查询日志" class="headerlink" title="3.5 全局查询日志"></a>3.5 全局查询日志</h3><ol>
<li>配置启用<br>在mysql的my.cnf中，设置如下：#开启general_log=1   # 记录日志文件的路径general_log_file=/path/logfile#输出格式log_output=FILE</li>
<li>编码启用<br> 命令set global general_log=1; #全局日志可以存放到日志文件中，也可以存放到Mysql系统表中。存放到日志中性能更好一些，存储到表中set global log_output=’TABLE’;    此后 ，你所编写的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看 select * from mysql.general_log;    </li>
<li>尽量不要在生产环境开启这个功能。</li>
</ol>
<h2 id="4-MySQL锁机制"><a href="#4-MySQL锁机制" class="headerlink" title="4. MySQL锁机制"></a>4. MySQL锁机制</h2><h3 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h3><p>4.1.1 定义<br>  锁是计算机协调多个进程或线程并发访问某一资源的机制。  在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。<br>4.1.2 锁的分类</p>
<ol>
<li>从对数据操作的类型（读\写）分<br>读锁(共享锁)：针对同一份数据，多个读操作可以同时进行而不会互相影响。<br>写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</li>
<li>从对数据操作的粒度分<br>为了尽可能提高数据库的并发度，每次锁定的数据范围越小越好，理论上每次只锁定当前操作的数据的方案会得到最大的并发度，但是管理锁是很耗资源的事情（涉及获取，检查，释放锁等动作），因此数据库系统需要在高并发响应和系统性能两方面进行平衡，这样就产生了“锁粒度（Lock granularity）”的概念。一种提高共享资源并发发性的方式是让锁定对象更有选择性。尽量只锁定需要修改的部分数据，而不是所有的资源。更理想的方式是，只对会修改的数据片进行精确的锁定。任何时候，在给定的资源上，锁定的数据量越少，则系统的并发程度越高，只要相互之间不发生冲突即可。</li>
</ol>
<ul>
<li>表锁</li>
<li>行锁</li>
</ul>
<h3 id="4-2-三锁"><a href="#4-2-三锁" class="headerlink" title="4.2 三锁"></a>4.2 三锁</h3><h4 id="4-2-1-表锁（偏读）"><a href="#4-2-1-表锁（偏读）" class="headerlink" title="4.2.1 表锁（偏读）"></a>4.2.1 表锁（偏读）</h4><p>表锁(偏读)<br>偏向MyISAM存储引擎，开销小，加锁快；无死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低。</p>
<p>【手动增加表锁】 lock table 表名字1 read(write)，表名字2 read(write)，其它;<br>【查看表上加过的锁】  show open tables; 【释放表锁】unlock tables;</p>
<p>加读锁<br>我们为mylock表加read锁(读阻塞写例子) session_1session_2获得表mylock的READ锁定连接终端当前session可以查询该表记录 其他session也可以查询该表的记录 当前session不能查询其它没有锁定的表 其他session可以查询或者更新未锁定的表 当前session中插入或者更新锁定的表都会提示错误： 其他session插入或者更新锁定表会一直等待获得锁： 释放锁 Session2获得锁，插入操作完成： </p>
<p>lock table mylock read,book write;<br>     <img src="/2022/01/05/MySQLSenior/35.png"><br> unlock tables;<br>  <img src="/2022/01/05/MySQLSenior/36.png"></p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td>获得表mylock的READ锁定  <img src="/2022/01/05/MySQLSenior/37.png"></td>
<td>连接终端</td>
</tr>
<tr>
<td>当前session可以查询该表记录 <img src="/2022/01/05/MySQLSenior/38.png"></td>
<td>其他session也可以查询该表的记录 <img src="/2022/01/05/MySQLSenior/39.png"></td>
</tr>
<tr>
<td>当前session不能查询其他没有锁定的表 <img src="/2022/01/05/MySQLSenior/40.png"></td>
<td>其他session可以查询或者更新未锁定的表<img src="/2022/01/05/MySQLSenior/41.png"></td>
</tr>
<tr>
<td>当前session中插入或者更新锁定的表都会提示错误<img src="/2022/01/05/MySQLSenior/42.png"></td>
<td>其他session插入或者更新锁定的表会一直等待获得锁<img src="/2022/01/05/MySQLSenior/43.png"></td>
</tr>
<tr>
<td>释放锁<img src="/2022/01/05/MySQLSenior/44.png"></td>
<td>session2获得锁，插入操作完成<img src="/2022/01/05/MySQLSenior/45.png"></td>
</tr>
</tbody></table>
<p>加写锁<br> mylockwrite(MyISAM) session_1session_2获得表mylock的WRITE锁定待Session1开启写锁后，session2再连接终端当前session对锁定表的查询+更新+插入操作都可以执行： 其他session对锁定表的查询被阻塞，需要等待锁被释放： 在锁表前，如果session2有数据缓存，锁表以后，在锁住的表不发生改变的情况下session2可以读出缓存数据，一旦数据发生改变，缓存将失效，操作将被阻塞住。释放锁 Session2获得锁，查询返回：    </p>
<table>
<thead>
<tr>
<th>session_1</th>
<th>session_2</th>
</tr>
</thead>
<tbody><tr>
<td>获得表mylock的write锁<img src="/2022/01/05/MySQLSenior/46.png"></td>
<td>待session_1开启写锁后，session2再连接终端</td>
</tr>
<tr>
<td>当前session对锁定表的查询+更新+插入操作都可以执行<img src="/2022/01/05/MySQLSenior/47.png"></td>
<td>其他session对锁定表的查询被阻塞，需要等待锁被释放<img src="/2022/01/05/MySQLSenior/48.png"></td>
</tr>
<tr>
<td>释放锁<img src="/2022/01/05/MySQLSenior/49.png"></td>
<td>session2获得锁，查询返回  <img src="/2022/01/05/MySQLSenior/50.png"></td>
</tr>
</tbody></table>
<p>总结：</p>
<ul>
<li><p>MyISAM在执行查询语句select前，会自动给设计的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。</p>
</li>
<li><p>MySQL的表级锁有两种模式</p>
<ul>
<li><p>表共享读锁</p>
</li>
<li><p>表独占写锁</p>
<table>
<thead>
<tr>
<th>锁类型</th>
<th>可否兼容</th>
<th>读锁</th>
<th>写锁</th>
</tr>
</thead>
<tbody><tr>
<td>读锁</td>
<td>是</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>写锁</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<p>结论：</p>
<ol>
<li>对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其他进程的写操作。</li>
<li>对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其他进程的读写操作<br> <font color="#F44336">读锁会阻塞写，但是不会阻塞读。写锁会把读和写都阻塞。</font></li>
</ol>
<p>表锁分析：</p>
<ol>
<li><p>看看哪些表被加锁了</p>
<pre class=" language-mysql"><code class="language-mysql">show open tables;
</code></pre>
</li>
<li><p>如何分析表锁定<br> 可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定。</p>
<pre class=" language-mysql"><code class="language-mysql">show status like "table%"
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/51.png"><br> Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1<br> Table_locks_waited：出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在着较严重的表级锁争用情况<br> <font color="#F44336">MyISAM的读写锁调度是写优先，这也是myisam不适合做为主表的引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。</font></p>
</li>
</ol>
<h4 id="4-2-2-行锁（偏写）"><a href="#4-2-2-行锁（偏写）" class="headerlink" title="4.2.2 行锁（偏写）"></a>4.2.2 行锁（偏写）</h4><p><strong>特点：</strong></p>
<ol>
<li>偏向InnoDB存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高。</li>
<li>InnoDB与MyISAM的最大不同有两点：一是支持事务（TRANSACTION）；二是采用了行级锁</li>
</ol>
<p><strong>行锁支持事务</strong><br>事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。</p>
<ol>
<li>原子性（Atomicity）<br>事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。 </li>
<li>一致性（Consistent）<br>在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</li>
<li>隔离性（Isolation）<br>数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。 </li>
<li>持久性（Durable）<br>事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。 </li>
</ol>
<p><strong>并发事务处理带来的问题</strong></p>
<ol>
<li>更新丢失<br> 当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题－－最后的更新覆盖了由其他事务所做的更新。例如，两个程序员修改同一java文件。每程序员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改副本的编辑人员覆盖前一个程序员所做的更改。如果在一个程序员完成并提交事务之前，另一个程序员不能访问同一文件，则可避免此问题。 </li>
<li>脏读<br>一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做”脏读”。 一句话：事务A读取到了事务B已修改但尚未提交的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取的数据无效，不符合一致性要求。</li>
<li>不可重复读<br> 在一个事务内，多次读同一个数据。在这个事务还没有结束时，另一个事务也访问该同一数据。那么，在第一个事务的两次读数据之间。由于第二个事务的修改，那么第一个事务读到的数据可能不一样，这样就发生了在一个事务内两次读到的数据是不一样的，因此称为不可重复读，即原始读取不可重复。       一句话：一个事务范围内两个相同的查询却返回了不同数据。 </li>
<li>幻读<br>一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读”。 一句话：事务A 读取到了事务B提交的新增数据，不符合隔离性。   脏读是事务B里面修改了数据<br> 幻读是事务B里面新增了数据</li>
</ol>
<p><strong>事务隔离级别</strong><br>脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。 数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上 “串行化”进行，这显然与“并发”是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。<br>常看当前数据库的事务隔离级别</p>
<pre class=" language-mysql"><code class="language-mysql">show variables like 'tx_isolation';
</code></pre>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>读数据一致性</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>未提交读</td>
<td>最低级别，只能保证不读取物理上损坏的数据</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>已提交读</td>
<td>语句级</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>可重复读</td>
<td>事务级</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>可序列化</td>
<td>最高级别，事务级</td>
<td>否</td>
<td>否</td>
<td></td>
</tr>
</tbody></table>
<p>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上串行化进行，这显然与并发是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对不可重复读和幻读并不敏感，可能更关心数据并发访问的能力。</p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td><img src="/2022/01/05/MySQLSenior/52.png"></td>
<td><img src="/2022/01/05/MySQLSenior/53.png"></td>
</tr>
<tr>
<td>更新但是不提交，没有手写commit<img src="/2022/01/05/MySQLSenior/54.png"></td>
<td>session2被阻塞，只能等待<img src="/2022/01/05/MySQLSenior/55.png"></td>
</tr>
<tr>
<td>提交更新<img src="/2022/01/05/MySQLSenior/56.png"></td>
<td>commit命令执行</td>
</tr>
<tr>
<td></td>
<td>commit命令执行</td>
</tr>
<tr>
<td>更新a=1</td>
<td>更新a=9</td>
</tr>
</tbody></table>
<p><strong>无索引行锁升级为表锁</strong><br> Session_1Session_2正常情况，各自锁定各自的行，互相不影响，一个2000另一个3000由于在column字段b上面建了索引，如果没有正常使用，会导致行锁变表锁比如没加单引号导致索引失效，行锁变表锁被阻塞，等待。只到Session_1提交后才阻塞解除，完成更新 </p>
<p><strong>间隙锁危害</strong><br> 间隙锁带来的插入问题 Session_1Session_2阻塞产生，暂时不能插入commit;阻塞解除，完成插入<br>【什么是间隙锁】当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（GAP Lock）。<br>【危害】因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</p>
<table>
<thead>
<tr>
<th>session1</th>
<th>session2</th>
</tr>
</thead>
<tbody><tr>
<td>查询表的内容，无a=2的记录<img src="/2022/01/05/MySQLSenior/58.png"></td>
<td>连接终端</td>
</tr>
<tr>
<td>更改表的记录，未提交<img src="/2022/01/05/MySQLSenior/59.png"></td>
<td>插入表的记录<img src="/2022/01/05/MySQLSenior/60.png"></td>
</tr>
<tr>
<td>提交记录 <img src="/2022/01/05/MySQLSenior/61.png"></td>
<td>插入成功并提交commit  <img src="/2022/01/05/MySQLSenior/62.png"></td>
</tr>
<tr>
<td>查看数据  <img src="/2022/01/05/MySQLSenior/63.png"></td>
<td></td>
</tr>
</tbody></table>
<p>案例结论：</p>
<ol>
<li> Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势了。  </li>
<li>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</li>
</ol>
<p>  <strong>如何分析行锁：</strong><br>【如何分析行锁定】通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况</p>
<pre class=" language-mysql"><code class="language-mysql"> mysql>show status like 'innodb_row_lock%';
</code></pre>
<p> <img src="/2022/01/05/MySQLSenior/70.png"><br>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</p>
<p>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</p>
<p>Innodb_row_lock_time_avg：每次等待所花平均时间；<br>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；<br>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；对于这5个状态变量，比较重要的主要是 </p>
<p>Innodb_row_lock_time_avg（等待平均时长）</p>
<p>Innodb_row_lock_waits（等待总次数）  </p>
<p>Innodb_row_lock_time（等待总时长）这三项。尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。最后可以通过SELECT * FROM information_schema.INNODB_TRX\G;来查询正在被锁阻塞的sql语句。</p>
<p><strong>Select也可以加锁</strong><br>读锁：select ..lock in share mode<br>共享锁(Share Lock) 共享锁又称读锁，是读取操作创建的锁。其他用户可以并发读取数据，但任何事务都不能对数据进行修改（获取数据上的排他锁），直到已释放所有共享锁。如果事务T对数据A加上共享锁后，则其他事务只能对A再加共享锁，不能加排他锁。获准共享锁的事务只能读数据，不能修改数据。 用法SELECT … LOCK IN SHARE MODE; 在查询语句后面增加 LOCK IN SHARE MODE ，Mysql会对查询结果中的每行都加共享锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请共享锁，否则会被阻塞。其他线程也可以读取使用了共享锁的表（行？），而且这些线程读取的是同一个版本的数据。 </p>
<p>写锁<br>select… for update  【select * from a where a=1 for update   锁定一行】<br>排他锁（eXclusive Lock）共享锁又称写锁，如果事务T对数据A加上排他锁后，则其他事务不能再对A加任任何类型的封锁。获准排他锁的事务既能读数据，又能修改数据。用法SELECT … FOR UPDATE;       在查询语句后面增加 FOR UPDATE ，Mysql会对查询结果中的每行都加排他锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请排他锁，否则会被阻塞。 </p>
<p>优化建议：</p>
<ol>
<li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁。</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>锁住某行后，尽量不要去调别的行或表，赶紧处理被锁住的行然后释放掉锁。</li>
<li>涉及相同表的事务，对于调用表的顺序尽量保持一致。</li>
<li>在业务环境允许的情况下,尽可能低级别事务隔离</li>
</ol>
<h4 id="4-2-3-页锁"><a href="#4-2-3-页锁" class="headerlink" title="4.2.3 页锁"></a>4.2.3 页锁</h4><p>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</p>
<h2 id="5-主从复制"><a href="#5-主从复制" class="headerlink" title="5. 主从复制"></a>5. 主从复制</h2><h3 id="5-1-复制的基本原理"><a href="#5-1-复制的基本原理" class="headerlink" title="5.1 复制的基本原理"></a>5.1 复制的基本原理</h3><p>slave会从master读取binlog来进行数据同步<br>三步骤+原理图<br> <img src="/2022/01/05/MySQLSenior/71.png"><br> MySQL复制过程分成三步</p>
<ol>
<li>master将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件，binary log events；</li>
<li>slave将master的binary log events拷贝到它的中继日志（relay log）；</li>
<li>slave重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的 </li>
</ol>
<p>master将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件，binary log events<br>slave将master的binary log events拷贝到它的中继日志（relay log）<br>slave重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的</p>
<h3 id="5-2-复制的基本原则"><a href="#5-2-复制的基本原则" class="headerlink" title="5.2 复制的基本原则"></a>5.2 复制的基本原则</h3><ol>
<li>每个slave只有一个master</li>
<li>每个slave只能有一个唯一的服务器ID</li>
<li>每个master可以有多个salve</li>
</ol>
<h3 id="5-3-复制的最大问题"><a href="#5-3-复制的最大问题" class="headerlink" title="5.3 复制的最大问题"></a>5.3 复制的最大问题</h3><p>延时</p>
<h3 id="5-5-一主一从常见配置（待更新步骤）"><a href="#5-5-一主一从常见配置（待更新步骤）" class="headerlink" title="5.5 一主一从常见配置（待更新步骤）"></a>5.5 一主一从常见配置（待更新步骤）</h3><ol>
<li>mysql版本一致且后台以服务运行</li>
<li>主从都配置在[mysqld]结点下，都是小写</li>
<li>主机修改my.ini配置文件<ul>
<li>[必须]主服务器唯一ID。<br>server-id=1</li>
<li>[必须]启用二进制日志</li>
<li>[可选]启用错误日志</li>
<li>[可选]根目录</li>
<li>[可选]临时目录</li>
<li>[可选]数据目录</li>
<li>read-only=0</li>
<li>[可选]设置不要复制的数据库</li>
<li>[可选]设置需要复制的数据库</li>
</ul>
</li>
<li>从机修改my.cnf配置文件<ul>
<li>[必须]从服务器唯一ID</li>
<li>[可选]启用二进制日志</li>
</ul>
</li>
<li>因修改过配置文件，请主机+从机都重启后台mysql服务</li>
<li>主机从机都关闭防火墙<ul>
<li>windows手动关闭</li>
<li>关闭虚拟机linux防火墙    service iptables stop</li>
</ul>
</li>
<li>在Windows主机上建立帐户并授权slave<ul>
<li>GRANT REPLICATION SLAVE ON <em>.</em> TO ‘zhangsan‘@’从机器数据库IP’ IDENTIFIED BY ‘123456’;</li>
<li>Subtopic</li>
<li>flush privileges;</li>
<li>查询master的状态<ul>
<li>show master status;</li>
<li>记录下File和Position的值</li>
</ul>
</li>
<li>执行完此步骤后不要再操作主服务器MYSQL，防止主服务器状态值变化</li>
</ul>
</li>
<li>在Linux从机上配置需要复制的主机<ul>
<li>CHANGE MASTER TO MASTER_HOST=’主机IP’,MASTER_USER=’zhangsan’,MASTER_PASSWORD=’123456’,MASTER_LOG_FILE=’File名字’,MASTER_LOG_POS=Position数字;</li>
<li>启动从服务器复制功能<ul>
<li>start slave;</li>
</ul>
</li>
<li>show slave status\G<ul>
<li>下面两个参数都是Yes，则说明主从配置成功！</li>
<li>Slave_IO_Running: Yes</li>
<li>Slave_SQL_Running: Yes</li>
</ul>
</li>
</ul>
</li>
<li>主机新建库、新建表、insert记录，从机复制</li>
<li>如何停止从服务复制功能</li>
</ol>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL/">
                                    <span class="chip bg-color">MySQL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'rFeUWk7NpQXiluzcxdQENisf-gzGzoHsz',
        appKey: 'B4wlcRkF1MrkcQu6RWXSnyN4',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/07/Linux/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Linux基础（一）常用命令">
                        
                        <span class="card-title">Linux基础（一）常用命令</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux/" class="post-category">
                                    Linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/03/testEnvironmentSetup/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="测试环境搭建">
                        
                        <span class="card-title">测试环境搭建</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95/" class="post-category">
                                    软件测试
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95/">
                        <span class="chip bg-color">软件测试</span>
                    </a>
                    
                    <a href="/tags/%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">
                        <span class="chip bg-color">测试环境搭建</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Helene<br />'
            + '文章作者: Helene<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="4965675848"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <a href="/about" target="_blank">Helene</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">50.9k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
			
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "12";
                        var startDate = "23";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    
    <script src="/js/FunnyTitle.js"></script>
</body>

</html>
